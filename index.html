<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>New Tran English App - Grade 9 Speaking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #fce38a, #f38181);
      --card-bg: #ffffffcc;
      --primary: #ff6f61;
      --primary-dark: #e65b4f;
      --accent: #45b7d1;
      --accent-soft: #e0f7ff;
      --text-main: #333;
      --timer-color: #d32f2f;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      margin: 0; min-height: 100vh;
      background: var(--bg-gradient); color: var(--text-main);
      padding-bottom: 50px;
    }
    .page { max-width: 960px; margin: 0 auto; padding: 16px 12px 40px; }
    h1 { text-align: center; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.18); margin: 8px 0 4px; font-size: 22px; }
    .subtitle { text-align: center; color: #fff; font-size: 13px; margin-bottom: 10px; }
    .card { background: var(--card-bg); backdrop-filter: blur(6px); border-radius: 16px; padding: 14px 16px; margin-top: 12px; box-shadow: 0 6px 14px rgba(0,0,0,0.15); }
    .card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .pill { padding: 2px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; background: var(--accent-soft); color: #0077a3; white-space: nowrap; }
    .label { font-weight: 600; margin: 6px 0 2px; font-size: 14px; }

    input, select, textarea {
      width: 100%; border-radius: 10px; border: 1px solid #ddd;
      padding: 10px; margin: 2px 0 8px; font-size: 16px;
      font-family: inherit; outline: none;
      transition: border 0.15s, box-shadow 0.15s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(69, 183, 209, 0.25);
    }
    textarea { resize: vertical; min-height: 80px; line-height: 1.5; }
    textarea[readonly] { background-color: #e9ecef; color: #495057; cursor: not-allowed; }

    button {
      border: none; border-radius: 999px; padding: 10px 20px;
      font-size: 15px; font-weight: 600; cursor: pointer;
      font-family: inherit; display: inline-flex; align-items: center;
      gap: 6px; transition: background 0.15s, transform 0.1s;
      touch-action: manipulation;
    }
    button:active { transform: translateY(2px); }
    .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(230, 91, 79, 0.45); }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: #fff; color: var(--primary); border: 1px solid rgba(0,0,0,0.06); }
    .btn-secondary:disabled, .btn-primary:disabled { opacity: 0.65; cursor: default; box-shadow: none; }
    .btn-danger { background: #ff4444; color: white; box-shadow: 0 4px 10px rgba(255, 68, 68, 0.4); }
    .btn-speak { background: #4caf50; color: #fff; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4); }

    .timer-display {
      font-size: 28px; font-weight: 800; color: var(--timer-color);
      background: #fff; padding: 5px 15px; border-radius: 8px;
      border: 2px solid var(--timer-color); margin-left: auto;
    }

    .status { font-size: 13px; margin-top: 4px; font-weight: 600; }
    .status-ok { color: #1b8f3b; }
    .status-error { color: #c62828; }
    .small { font-size: 12px; color: #555; }

    #questionTextContainer { display: none; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .marquee {
      width: 100%; overflow: hidden; white-space: nowrap; box-sizing: border-box;
      background: rgba(255,255,255,0.18); padding: 6px 0; margin-bottom: 6px;
      border-radius: 8px; backdrop-filter: blur(3px);
    }
    .marquee span {
      display: inline-block; padding-left: 100%; font-weight: bold;
      color: #d50000; font-size: 16px; animation: marqueeAnim 14s linear infinite;
    }
    @keyframes marqueeAnim {
      0% { transform: translateX(0%); }
      100% { transform: translateX(-100%); }
    }

    #inapp-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); z-index: 9999; color: white;
      display: none; flex-direction: column; align-items: center;
      justify-content: center; text-align: center; padding: 20px;
    }
    .arrow-up {
      font-size: 40px; margin-bottom: 10px; animation: bounce 1s infinite;
      position: absolute; top: 20px; right: 20px;
    }
    @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    .footer {
      text-align: center;
      margin-top: 16px;
      color: #fff;
      font-size: 13px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .mini-banner {
      border-radius: 12px; padding: 10px 12px; background: rgba(255,255,255,0.85);
      border: 1px solid rgba(0,0,0,0.06); margin-top: 10px;
    }

    .upload-progress {
      display: none;
      margin-top: 12px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 13px;
      font-weight: 600;
    }
    .progress-bar-container {
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
    }
    .progress-bar {
      width: 0%;
      height: 100%;
      background: #4caf50;
      transition: width 0.3s ease;
    }
  </style>
</head>

<body>
  <div id="inapp-overlay">
    <div class="arrow-up">‚Üó</div>
    <h3>‚ö†Ô∏è C·∫£nh b√°o tr√¨nh duy·ªát</h3>
    <p>Microphone kh√¥ng ho·∫°t ƒë·ªông tr√™n Zalo/Facebook.</p>
    <p style="background:#444; padding:15px; border-radius:8px; margin-top:15px;">
      Vui l√≤ng nh·∫•n d·∫•u <strong>3 ch·∫•m (...)</strong> g√≥c tr√™n ph·∫£i <br>
      Ch·ªçn <strong>"M·ªü b·∫±ng tr√¨nh duy·ªát" (Open in Browser)</strong>
    </p>
  </div>

  <div class="marquee">
    <span>‚òÖ Mr. T√¢n Tr·∫ßn Ng·ªçc ‚Äì Xu√¢n PhuÃÅ lower secondary school ‚òÖ</span>
  </div>

  <div class="page">
    <h1>New Tran English App</h1>
    <div class="subtitle">Luy·ªán n√≥i ti·∫øng Anh ‚Äì Grade 9</div>

    <!-- Pending resend (t·ªëi ∆∞u kh·ªëi 6) -->
    <div id="pendingBox" class="mini-banner" style="display:none;">
      <div><strong>‚ö†Ô∏è C√≥ 1 b√†i ch∆∞a g·ª≠i xong (do l·ªói m·∫°ng)</strong></div>
      <div class="small" id="pendingInfo"></div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="resendPendingBtn" class="btn-primary" type="button">üì§ G·ª≠i l·∫°i b√†i v·ª´a l∆∞u</button>
        <button id="clearPendingBtn" class="btn-secondary" type="button">üßπ X√≥a b√†i l∆∞u</button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="pill">B∆∞·ªõc 0</div>
        <div><strong>Th√¥ng tin h·ªçc sinh</strong></div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <div style="flex:2;">
          <div class="label">H·ªç v√† t√™n:</div>
          <input id="studentName" placeholder="Nguy·ªÖn VƒÉn Nam" />
        </div>
        <div style="flex:1;">
          <div class="label">L·ªõp:</div>
          <input id="studentClass" placeholder="9A" />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="pill">B∆∞·ªõc 1</div>
        <div><strong>Ch·ªçn b√†i luy·ªán n√≥i</strong></div>
      </div>
      <div class="label">Kh·ªëi l·ªõp:</div><select id="gradeSelect"></select>
      <div class="label">Ch·ªß ƒë·ªÅ:</div><select id="topicSelect"></select>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="pill">B∆∞·ªõc 2</div>
        <div><strong>Nghe & Hi·ªÉu y√™u c·∫ßu</strong></div>
      </div>
      <div style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
        <button id="speakQuestionBtn" class="btn-speak" type="button">üîä Nghe ƒë·ªÅ b√†i</button>
        <button id="showTextBtn" class="btn-secondary" type="button">üëÅÔ∏è Hi·ªán vƒÉn b·∫£n</button>
      </div>
      <div id="questionTextContainer">
        <div class="label">N·ªôi dung y√™u c·∫ßu:</div>
        <textarea id="question" rows="6" readonly style="background:#f9f9f9; color:#555; font-size:15px;"></textarea>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="pill">B∆∞·ªõc 3</div>
        <div><strong>Tr·∫£ l·ªùi & G·ª≠i</strong></div>
      </div>

      <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
        <button id="startBtn" class="btn-primary" type="button">üéô B·∫Øt ƒë·∫ßu n√≥i</button>
        <button id="stopBtn" class="btn-secondary" type="button" disabled>‚èπ D·ª´ng</button>
        <div id="timerDisplay" class="timer-display">03:00</div>
      </div>

      <div id="status" class="status">Nh·∫•n "B·∫Øt ƒë·∫ßu n√≥i" ƒë·ªÉ tr·∫£ l·ªùi.</div>

      <div class="label">Transcript (HS n√≥i):</div>
      <textarea id="answerText" rows="8" readonly
        placeholder="N·ªôi dung b·∫°n n√≥i s·∫Ω hi·ªán ·ªü ƒë√¢y..."
        style="background-color:#f0f8ff; font-size:16px; color:#000;"></textarea>

      <div style="margin-top:10px;">
        <button id="clearBtn" class="btn-danger" type="button"
          style="width:100%; justify-content:center;">
          üóë X√≥a c√¢u tr·∫£ l·ªùi & L√†m l·∫°i
        </button>
      </div>

      <br>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="sendBtn" class="btn-primary" type="button" disabled
          style="flex:1; justify-content:center;">üì© N·ªôp b√†i cho GV</button>
        <button id="suggestBtn" class="btn-secondary" type="button" disabled
          style="flex:1; justify-content:center;">üí° Xem g·ª£i √Ω</button>
      </div>

      <div id="uploadProgress" class="upload-progress">
        <div class="progress-header">
          <span>ƒêang t·∫£i l√™n...</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="progress-bar-container">
          <div id="progressBar" class="progress-bar"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>K·∫øt qu·∫£ g·ª≠i</h2>
      <div id="resultArea" class="small">Ch∆∞a g·ª≠i.</div>
    </div>

    <div class="card">
      <h2>G·ª£i √Ω tr·∫£ l·ªùi / Suggested Answers</h2>
      <div id="suggestionsArea" class="small"
        style="white-space: pre-line; background: #fff; padding: 10px;
               border-radius: 8px; border: 1px solid #eee;">
        (B·∫°n s·∫Ω xem ƒë∆∞·ª£c g·ª£i √Ω sau khi g·ª≠i b√†i cho gi√°o vi√™n.)
      </div>
    </div>

    <div class="footer">
      ¬© New Tran English App ‚Äì T√¢n Tr·∫ßn Ng·ªçc &amp; Google Apps Script
    </div>
  </div>

<script>
  // ===================== APPS SCRIPT URL =====================
  // N·∫øu b·∫°n ch·∫°y ngo√†i GAS (GitHub Pages/Netlify): ƒëi·ªÅn link /exec
  // V√≠ d·ª•: https://script.google.com/macros/s/AKfycb.../exec
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxuEMotw0K0NwURKXo1HQukM9rAq9RLEoRcxHHoUgDnURBdsUtc738j4viPRJoFzA1rkQ/exec"; //
  // ==========================================================

  const $ = (id) => document.getElementById(id);
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  // ======= Pending Ï†ÄÏû• (kh·ªëi 6) =======
  const PENDING_KEY = "NEWTRAN_G9_PENDING_SUBMISSION_V1";

  function savePending(payload) {
    try {
      const obj = { payload, savedAt: new Date().toISOString() };
      localStorage.setItem(PENDING_KEY, JSON.stringify(obj));
      showPendingBox();
    } catch(e) {}
  }
  function clearPending() {
    try { localStorage.removeItem(PENDING_KEY); } catch(e) {}
    $("pendingBox").style.display = "none";
  }
  function getPending() {
    try {
      const s = localStorage.getItem(PENDING_KEY);
      if (!s) return null;
      return JSON.parse(s);
    } catch(e) { return null; }
  }
  function showPendingBox() {
    const p = getPending();
    if (!p) { $("pendingBox").style.display = "none"; return; }
    $("pendingBox").style.display = "block";
    const dt = p.savedAt ? new Date(p.savedAt) : null;
    const when = dt ? dt.toLocaleString("vi-VN") : "(unknown time)";
    const name = p.payload && p.payload.studentName ? p.payload.studentName : "";
    const cls = p.payload && p.payload.studentClass ? p.payload.studentClass : "";
    $("pendingInfo").textContent = `H·ªç t√™n: ${name} | L·ªõp: ${cls} | L∆∞u l√∫c: ${when}`;
  }

  $("resendPendingBtn").onclick = async () => {
    const p = getPending();
    if (!p || !p.payload) return;
    $("resultArea").textContent = "ƒêang g·ª≠i l·∫°i b√†i ƒë√£ l∆∞u...";
    $("resendPendingBtn").disabled = true;
    $("clearPendingBtn").disabled = true;

    const ok = await submitWithRetry(p.payload);
    $("resendPendingBtn").disabled = false;
    $("clearPendingBtn").disabled = false;

    if (ok) {
      clearPending();
      $("resultArea").innerHTML = '<span class="status-ok">ƒê√£ g·ª≠i l·∫°i th√†nh c√¥ng!</span>';
      // M·ªü g·ª£i √Ω (kh√¥ng c√≥ ph·∫£n h·ªìi no-cors, n√™n m·ªü sau khi g·ª≠i l·∫°i)
      canViewSuggestion = true;
      $("suggestBtn").disabled = false;
    } else {
      $("resultArea").innerHTML = '<span class="status-error">G·ª≠i l·∫°i th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i khi m·∫°ng ·ªïn ƒë·ªãnh.</span>';
    }
  };

  $("clearPendingBtn").onclick = () => {
    if (!confirm("X√≥a b√†i l∆∞u ch∆∞a g·ª≠i?")) return;
    clearPending();
  };

  // ======= in-app overlay =======
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  const isInApp = ua.indexOf("FBAN") > -1 || ua.indexOf("FBAV") > -1 || ua.indexOf("Zalo") > -1;
  if (isInApp) $("inapp-overlay").style.display = "flex";

  // ===================== DATA =====================
  const GRADES = [
    {
      id: "9",
      name: "Grade 9",
      topics: [
        { id: "g9_u1_1", name: "Unit 1 - Local Community (Topic 1: Activity)", vn: "Ho·∫°t ƒë·ªông c·ªông ƒë·ªìng" },
        { id: "g9_u1_2", name: "Unit 1 - Local Community (Topic 2: Helper)", vn: "Ng∆∞·ªùi gi√∫p ƒë·ª°" },
        { id: "g9_u2_1", name: "Unit 2 - City Life (Topic 1: Liked Feature)", vn: "ƒêi·ªÉm th√≠ch ·ªü TP" },
        { id: "g9_u2_2", name: "Unit 2 - City Life (Topic 2: Advantages)", vn: "L·ª£i √≠ch s·ªëng ·ªü TP" },
        { id: "g9_u2_3", name: "Unit 2 - City Life (Topic 3: Drawbacks)", vn: "H·∫°n ch·∫ø s·ªëng ·ªü TP" },
        { id: "g9_u3_1", name: "Unit 3 - Healthy Living (Topic 1: Habit)", vn: "Th√≥i quen l√†nh m·∫°nh" },
        { id: "g9_u3_2", name: "Unit 3 - Healthy Living (Topic 2: Time Mgmt)", vn: "Qu·∫£n l√Ω th·ªùi gian" },
        { id: "g9_u3_3", name: "Unit 3 - Healthy Living (Topic 3: Stress)", vn: "Gi·∫£m cƒÉng th·∫≥ng" },
        { id: "g9_u4_1", name: "Unit 4 - Remembering The Past", vn: "K·ª∑ ni·ªám qu√° kh·ª©" },
        { id: "g9_u5_1", name: "Unit 5 - Our Experiences", vn: "Tr·∫£i nghi·ªám m·ªõi" },
        { id: "g9_u6_1", name: "Unit 6 - VN Lifestyles: Then & Now", vn: "Thay ƒë·ªïi l·ªëi s·ªëng" },
        { id: "g9_u7_1", name: "Unit 7 - Natural Wonders", vn: "K·ª≥ quan thi√™n nhi√™n" },
        { id: "g9_u8_1", name: "Unit 8 - Tourism", vn: "Du l·ªãch" },
        { id: "g9_u9_1", name: "Unit 9 - World Englishes", vn: "C√°c lo·∫°i ti·∫øng Anh" },
        { id: "g9_u10_1", name: "Unit 10 - Planet Earth", vn: "V·∫•n ƒë·ªÅ m√¥i tr∆∞·ªùng" },
        { id: "g9_u11_1", name: "Unit 11 - Electronic Devices", vn: "Thi·∫øt b·ªã ƒëi·ªán t·ª≠" },
        { id: "g9_u12_1", name: "Unit 12 - Career Choices", vn: "L·ª±a ch·ªçn ngh·ªÅ nghi·ªáp" }
      ]
    }
  ];

  const GRADE_9_QUESTIONS = {
    "g9_u1_1": "Describe a community activity or event in your local area. You should say:\n‚Ä¢ what the activity/event is\n‚Ä¢ who usually takes part in it\n‚Ä¢ what people do during the activity\nAnd explain how this activity benefits your local community.",
    "g9_u1_2": "Describe your favourite community helper. You should say:\n‚Ä¢ who he/she is\n‚Ä¢ what he/she usually does\n‚Ä¢ how long he/she has been doing this work\nAnd explain why he/she is your favourite community helper.",
    "g9_u2_1": "Describe a feature of city life that you really like. You should say:\n‚Ä¢ what the feature is\n‚Ä¢ how it affects your daily life\n‚Ä¢ why it is important in big cities\nAnd explain why you enjoy this feature of city life.",
    "g9_u2_2": "Talk about the advantages of living in a city. You should say:\n‚Ä¢ what convenient services or facilities cities offer\n‚Ä¢ what opportunities people have in cities\n‚Ä¢ how city life supports education, transport, or entertainment\nAnd explain why many people prefer living in cities.",
    "g9_u2_3": "Talk about the drawbacks of living in a city. You should say:\n‚Ä¢ what problems people may face (noise, traffic, pollution‚Ä¶)\n‚Ä¢ how these problems affect residents\n‚Ä¢ who suffers the most from these issues\nAnd explain which drawback you think is the most serious and why.",
    "g9_u3_1": "Talk about a healthy habit that teenagers should develop. You should say:\n‚Ä¢ what the habit is\n‚Ä¢ how to practise it\n‚Ä¢ what benefits it brings\nAnd explain why this habit is especially important for teenagers.",
    "g9_u3_2": "Talk about the ways teenagers should manage their time effectively. You should say:\n‚Ä¢ why time management is important for teens\n‚Ä¢ what strategies they can use (planning, prioritising tasks, reducing screen time‚Ä¶)\n‚Ä¢ how these strategies help with schoolwork and daily life\nAnd explain how good time management can improve teenagers‚Äô lifestyle.",
    "g9_u3_3": "Talk about the ways teenagers can reduce stress. You should say:\n‚Ä¢ what causes stress for teenagers nowadays\n‚Ä¢ what activities or habits can help them relax\n‚Ä¢ who can support them when they feel stressed\nAnd explain why managing stress is essential for teenagers‚Äô mental health.",
    "g9_u4_1": "Describe a memorable event from your childhood. You should say:\n‚Ä¢ when it happened\n‚Ä¢ who was involved\n‚Ä¢ what you remember most about it\nAnd explain why this memory is still important to you.",
    "g9_u5_1": "Describe a new experience you have tried for the first time. You should say:\n‚Ä¢ what the experience was\n‚Ä¢ where and when you tried it\n‚Ä¢ how you felt during the experience\nAnd explain what you learned from this experience.",
    "g9_u6_1": "Describe a lifestyle change in Viet Nam over the years. You should say:\n‚Ä¢ what life was like in the past\n‚Ä¢ what life is like now\n‚Ä¢ what has changed the most\nAnd explain how these changes have affected people‚Äôs lives.",
    "g9_u7_1": "Describe a natural wonder you would like to visit. You should say:\n‚Ä¢ what it is\n‚Ä¢ where it is located\n‚Ä¢ what it is famous for\nAnd explain why you want to visit this natural wonder.",
    "g9_u8_1": "Describe a place you have visited as a tourist. You should say:\n‚Ä¢ where it is\n‚Ä¢ what you did there\n‚Ä¢ what you enjoyed most\nAnd explain why you would recommend this place to other tourists.",
    "g9_u9_1": "Describe a variety of English you find interesting. You should say:\n‚Ä¢ what the variety is (British, American, Australian, Singaporean‚Ä¶)\n‚Ä¢ how it sounds or how it is used\n‚Ä¢ where you learned about it\nAnd explain why this variety of English interests you.",
    "g9_u10_1": "Describe an environmental problem that worries you. You should say:\n‚Ä¢ what the problem is\n‚Ä¢ what causes it\n‚Ä¢ how it affects people and the Earth\nAnd explain what we should do to reduce this problem.",
    "g9_u11_1": "Describe an electronic device you use every day. You should say:\n‚Ä¢ what the device is\n‚Ä¢ what you use it for\n‚Ä¢ how it helps you in daily life\nAnd explain why this device is important to you.",
    "g9_u12_1": "Describe a job you would like to do in the future. You should say:\n‚Ä¢ what the job is\n‚Ä¢ why you are interested in it\n‚Ä¢ what skills or qualifications it requires\nAnd explain why this job suits your personality or abilities."
  };

  // G·ª£i √Ω: gi·ªØ nguy√™n d·ªØ li·ªáu g·ª£i √Ω b·∫°n ƒë√£ c√≥ (m√¨nh ƒë·ªÉ tr·ªëng demo ng·∫Øn ƒë·ªÉ b·∫°n d√°n l·∫°i n·∫øu mu·ªën)
  const SUGGESTED_ANSWERS = window.SUGGESTED_ANSWERS || {}; // b·∫°n c√≥ th·ªÉ d√°n object g·ª£i √Ω v√†o ƒë√¢y

  // ===================== TTS iOS English Voice Fix (GI·ªÆ) =====================
  let englishVoice = null;
  let pendingSpeakText = null;

  function selectEnglishVoice() {
    if (!("speechSynthesis" in window)) return null;
    const voices = window.speechSynthesis.getVoices();
    if (!voices || !voices.length) return null;

    const preferredNames = ["Samantha", "Karen", "Daniel", "Moira", "Serena", "Martha"];
    let v =
      voices.find(v => preferredNames.includes(v.name)) ||
      voices.find(v => v.lang && v.lang.toLowerCase().startsWith("en-us")) ||
      voices.find(v => v.lang && v.lang.toLowerCase().startsWith("en-gb")) ||
      voices.find(v => v.lang && v.lang.toLowerCase().startsWith("en"));

    englishVoice = v || null;
    return englishVoice;
  }

  if ("speechSynthesis" in window) {
    window.speechSynthesis.onvoiceschanged = function () {
      const hadPending = !!pendingSpeakText;
      selectEnglishVoice();
      if (englishVoice && hadPending) {
        const text = pendingSpeakText;
        pendingSpeakText = null;
        speakText(text);
      }
    };
    window.speechSynthesis.getVoices();
  }

  // ===================== AUDIO RECORDER (t·ªëi ∆∞u kh·ªëi 6) =====================
  const MAX_DATAURL_CHARS = 28_000_000;
  const SMALL_BLOB_MAX = 4 * 1024 * 1024; // <=4MB g·ª≠i dataUrl, l·ªõn h∆°n => chunk upload

  let recorderMode = ""; // "media" | "wav"
  let isFullRecordingStarted = false;
  let audioMimeType = "";
  let micStream = null;

  // MediaRecorder
  let mediaRecorder = null;
  let audioChunks = [];
  let fullAudioBlob = null;

  // WAV fallback
  const WAV_TARGET_RATE = 16000;
  let wavCtx = null, wavSource = null, wavProcessor = null, wavGain0 = null;
  let wavPaused = true;
  let wavBuffers = [];
  let wavInputRate = 48000;

  async function ensureMicStream() {
    if (micStream) return micStream;
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    return micStream;
  }

  function pickSupportedMime() {
    const candidates = ["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/ogg"];
    if (!window.MediaRecorder) return "";
    for (const t of candidates) {
      try { if (MediaRecorder.isTypeSupported(t)) return t; } catch(e) {}
    }
    return "";
  }

  function blobToDataUrl(blob, cb) {
    const fr = new FileReader();
    fr.onload = () => cb(fr.result);
    fr.onerror = () => cb(null);
    fr.readAsDataURL(blob);
  }

  // ---- chunk upload helpers ----
  function uint8ToBase64(u8) {
    let binary = "";
    const chunk = 0x8000;
    for (let i = 0; i < u8.length; i += chunk) {
      binary += String.fromCharCode.apply(null, u8.subarray(i, i + chunk));
    }
    return btoa(binary);
  }

  const uploadProgress = $("uploadProgress");
  const progressBar = $("progressBar");
  const progressPercent = $("progressPercent");

  async function uploadAudioInChunksNoCors(blob, mimeType, meta) {
    if (!APPS_SCRIPT_URL) throw new Error("Missing APPS_SCRIPT_URL");

    const uploadId = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    const bytes = new Uint8Array(await blob.arrayBuffer());

    const chunkBytes = 200 * 1024;
    const total = Math.ceil(bytes.length / chunkBytes);

    uploadProgress.style.display = "block";
    progressBar.style.width = "0%";
    progressPercent.textContent = "0%";

    const uploadChunkWithRetry = async (idx, b64, retries = 3) => {
      for (let attempt = 0; attempt < retries; attempt++) {
        try {
          await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({
              action: "uploadChunk",
              uploadId, idx, total,
              mimeType, b64
            })
          });
          return true;
        } catch (e) {
          if (attempt < retries - 1) await sleep(500 * (attempt + 1));
        }
      }
      return false;
    };

    for (let idx = 0; idx < total; idx++) {
      const start = idx * chunkBytes;
      const end = Math.min(start + chunkBytes, bytes.length);
      const part = bytes.subarray(start, end);
      const b64 = uint8ToBase64(part);

      const ok = await uploadChunkWithRetry(idx, b64);
      if (!ok) throw new Error(`Failed chunk ${idx + 1}/${total}`);

      const percent = Math.round(((idx + 1) / total) * 100);
      progressBar.style.width = `${percent}%`;
      progressPercent.textContent = `${percent}%`;
      await sleep(250);
    }

    const finalizeWithRetry = async (retries = 3) => {
      for (let attempt = 0; attempt < retries; attempt++) {
        try {
          await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({
              action: "finalizeUpload",
              uploadId, total, mimeType,
              ...meta
            })
          });
          return true;
        } catch (e) {
          if (attempt < retries - 1) await sleep(1000 * (attempt + 1));
        }
      }
      return false;
    };

    const okFinal = await finalizeWithRetry();
    setTimeout(() => (uploadProgress.style.display = "none"), 900);
    if (!okFinal) throw new Error("Finalize failed");
    return true;
  }

  // ---- WAV fallback ----
  function downsampleBuffer(inputFloat32, inRate, outRate) {
    if (outRate === inRate) return inputFloat32;
    if (outRate > inRate) return inputFloat32;

    const ratio = inRate / outRate;
    const newLen = Math.round(inputFloat32.length / ratio);
    const result = new Float32Array(newLen);

    let offsetResult = 0;
    let offsetBuffer = 0;

    while (offsetResult < result.length) {
      const nextOffsetBuffer = Math.round((offsetResult + 1) * ratio);
      let accum = 0, count = 0;
      for (let i = offsetBuffer; i < nextOffsetBuffer && i < inputFloat32.length; i++) {
        accum += inputFloat32[i];
        count++;
      }
      result[offsetResult] = count ? (accum / count) : 0;
      offsetResult++;
      offsetBuffer = nextOffsetBuffer;
    }
    return result;
  }

  function floatTo16BitPCM(float32Array) {
    const out = new Int16Array(float32Array.length);
    for (let i = 0; i < float32Array.length; i++) {
      let s = Math.max(-1, Math.min(1, float32Array[i]));
      out[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
    }
    return out;
  }

  function encodeWav(int16Data, sampleRate) {
    const buffer = new ArrayBuffer(44 + int16Data.length * 2);
    const view = new DataView(buffer);

    function writeString(offset, str){
      for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
    }

    const numChannels = 1;
    const bitsPerSample = 16;
    const byteRate = sampleRate * numChannels * bitsPerSample / 8;
    const blockAlign = numChannels * bitsPerSample / 8;
    const dataSize = int16Data.length * 2;

    writeString(0, "RIFF");
    view.setUint32(4, 36 + dataSize, true);
    writeString(8, "WAVE");
    writeString(12, "fmt ");
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, numChannels, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, byteRate, true);
    view.setUint16(32, blockAlign, true);
    view.setUint16(34, bitsPerSample, true);
    writeString(36, "data");
    view.setUint32(40, dataSize, true);

    let offset = 44;
    for (let i = 0; i < int16Data.length; i++, offset += 2) {
      view.setInt16(offset, int16Data[i], true);
    }
    return new Blob([buffer], { type: "audio/wav" });
  }

  async function startWavRecordingIfNeeded() {
    if (isFullRecordingStarted && recorderMode === "wav") return;

    await ensureMicStream();

    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if (!AudioCtx) throw new Error("WebAudio not supported");

    wavCtx = new AudioCtx({ latencyHint: "interactive" });
    try { await wavCtx.resume(); } catch(e){}

    wavInputRate = wavCtx.sampleRate || 48000;
    wavBuffers = [];
    wavPaused = true;

    wavSource = wavCtx.createMediaStreamSource(micStream);
    const bufferSize = 4096;
    wavProcessor = wavCtx.createScriptProcessor(bufferSize, 1, 1);

    wavGain0 = wavCtx.createGain();
    wavGain0.gain.value = 0;

    wavProcessor.onaudioprocess = (e) => {
      if (wavPaused) return;
      try {
        const input = e.inputBuffer.getChannelData(0);
        const down = downsampleBuffer(input, wavInputRate, WAV_TARGET_RATE);
        const pcm16 = floatTo16BitPCM(down);
        wavBuffers.push(pcm16);
      } catch(err) {}
    };

    wavSource.connect(wavProcessor);
    wavProcessor.connect(wavGain0);
    wavGain0.connect(wavCtx.destination);

    recorderMode = "wav";
    audioMimeType = "audio/wav";
    isFullRecordingStarted = true;
  }

  function stopWavRecording(cb) {
    try { wavPaused = true; } catch(e){}
    try { if (wavProcessor) wavProcessor.disconnect(); } catch(e){}
    try { if (wavSource) wavSource.disconnect(); } catch(e){}
    try { if (wavGain0) wavGain0.disconnect(); } catch(e){}

    const chunks = wavBuffers || [];
    let totalLen = 0;
    for (const a of chunks) totalLen += a.length;

    const merged = new Int16Array(totalLen);
    let off = 0;
    for (const a of chunks) { merged.set(a, off); off += a.length; }

    const blob = encodeWav(merged, WAV_TARGET_RATE);

    const ctxToClose = wavCtx;
    wavCtx = null; wavSource = null; wavProcessor = null; wavGain0 = null;
    wavBuffers = [];
    if (ctxToClose) { try { ctxToClose.close(); } catch(e) {} }

    cb && cb(blob);
  }

  async function startMediaRecordingIfNeeded() {
    if (isFullRecordingStarted && recorderMode === "media" && mediaRecorder) return;

    if (!window.MediaRecorder) throw new Error("MediaRecorder not supported");
    await ensureMicStream();

    audioMimeType = pickSupportedMime() || "";
    audioChunks = [];
    fullAudioBlob = null;

    mediaRecorder = new MediaRecorder(
      micStream,
      audioMimeType ? { mimeType: audioMimeType } : undefined
    );

    mediaRecorder.ondataavailable = (e) => {
      if (e.data && e.data.size > 0) audioChunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
      try { fullAudioBlob = new Blob(audioChunks, { type: audioMimeType || "audio/webm" }); } catch(e) {}
    };

    try { mediaRecorder.start(1000); } catch(e) { mediaRecorder.start(); }

    recorderMode = "media";
    isFullRecordingStarted = true;
  }

  async function startFullRecordingIfNeeded() {
    try { await startMediaRecordingIfNeeded(); }
    catch(e) { await startWavRecordingIfNeeded(); }
  }

  function pauseFullRecording() {
    if (!isFullRecordingStarted) return;
    if (recorderMode === "media" && mediaRecorder) {
      if (mediaRecorder.state === "recording") { try { mediaRecorder.pause(); } catch(e){} }
    } else if (recorderMode === "wav") {
      wavPaused = true;
    }
  }

  function resumeFullRecording() {
    if (!isFullRecordingStarted) return;
    if (recorderMode === "media" && mediaRecorder) {
      if (mediaRecorder.state === "paused") { try { mediaRecorder.resume(); } catch(e){} }
    } else if (recorderMode === "wav") {
      wavPaused = false;
    }
  }

  function stopFullRecording(cb) {
    if (!isFullRecordingStarted) { cb && cb(null); return; }
    if (recorderMode === "media" && mediaRecorder) {
      try { mediaRecorder.requestData(); } catch(e){}
      const prevOnStop = mediaRecorder.onstop;
      mediaRecorder.onstop = () => {
        try { fullAudioBlob = new Blob(audioChunks, { type: audioMimeType || "audio/webm" }); } catch(e) {}
        mediaRecorder.onstop = prevOnStop;
        cb && cb(fullAudioBlob);
      };
      try { mediaRecorder.stop(); } catch(e) { cb && cb(null); }
    } else if (recorderMode === "wav") {
      stopWavRecording(cb);
    } else {
      cb && cb(null);
    }
  }

  // ===================== SpeechRecognition (GI·ªÆ) =====================
  let recognition = null;
  let timerInterval = null;
  let isRecording = false;
  let ignore_onend = false;
  let lastFinalNorm = "";
  let canViewSuggestion = false;

  function normalizeText(text) {
    return text.toLowerCase().replace(/[^a-z0-9]+/g, " ").trim();
  }
  function collapseRepeatingWords(text) {
    const words = text.trim().split(/\s+/);
    if (words.length <= 1) return text;
    const result = [];
    let last = ""; let count = 0;
    for (const w of words) {
      const lw = w.toLowerCase();
      if (lw === last) {
        count++;
        if (count >= 2) continue;
      } else {
        last = lw; count = 0;
      }
      result.push(w);
    }
    return result.join(" ");
  }

  function initSpeech() {
    const SpeechCls = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechCls) {
      alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Mic. Vui l√≤ng d√πng Chrome.");
      recognition = null;
      return;
    }

    recognition = new SpeechCls();
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.lang = "en-US";

    recognition.onstart = () => {
      $("status").textContent = "ƒêang nghe... (N√≥i to v√† r√µ)";
      $("startBtn").disabled = true;
      $("stopBtn").disabled = false;
    };

    recognition.onend = () => {
      if (isRecording && !ignore_onend) {
        try { recognition.start(); } catch(e) {}
        return;
      }
      $("status").textContent = "ƒê√£ d·ª´ng.";
      $("startBtn").disabled = false;
      $("stopBtn").disabled = true;
    };

    recognition.onresult = (event) => {
      if (!isRecording) return;
      if (!event.results) return;

      let newText = "";

      for (let i = event.resultIndex; i < event.results.length; ++i) {
        const res = event.results[i];
        if (!res.isFinal) continue;

        const txt = res[0] && res[0].transcript ? res[0].transcript.trim() : "";
        if (!txt) continue;

        let norm = normalizeText(txt);
        if (!norm) continue;

        if (norm === "im ready" || norm === "i am ready") continue;
        if (norm === lastFinalNorm) continue;
        lastFinalNorm = norm;

        newText += (newText ? " " : "") + txt;
      }

      if (!newText) return;

      let prev = $("answerText").value.trim();
      let combined = prev ? prev + " " + newText : newText;
      combined = collapseRepeatingWords(combined);

      $("answerText").value = combined;
      $("answerText").scrollTop = $("answerText").scrollHeight;

      $("sendBtn").disabled = combined.trim().length === 0;
    };
  }

  // ===================== Timer (GI·ªÆ + t·ª± stop khi h·∫øt gi·ªù) =====================
  function startTimer() {
    let duration = 180;
    clearInterval(timerInterval);
    $("timerDisplay").textContent = "03:00";

    timerInterval = setInterval(() => {
      duration--;
      const m = Math.floor(duration / 60);
      const s = duration % 60;
      $("timerDisplay").textContent =
        (m < 10 ? "0" + m : m) + ":" + (s < 10 ? "0" + s : s);

      if (duration <= 0) {
        clearInterval(timerInterval);
        $("timerDisplay").textContent = "00:00";
        // auto stop
        try { $("stopBtn").click(); } catch(e) {}
      }
    }, 1000);
  }

  function stopTimer() {
    clearInterval(timerInterval);
    $("timerDisplay").textContent = "03:00";
  }

  // ===================== Speak Text (GI·ªÆ + pause recording) =====================
  function speakText(text) {
    if (!("speechSynthesis" in window)) return;

    // D·ª´ng recognition ƒë·ªÉ tr√°nh t·ª± ghi "gi·ªçng ƒë·ªçc ƒë·ªÅ"
    if (recognition) {
      isRecording = false;
      ignore_onend = true;
      try { recognition.stop(); } catch(e) {}
      $("startBtn").disabled = false;
      $("stopBtn").disabled = true;
    }

    // Pause audio recording trong l√∫c ƒë·ªçc ƒë·ªÅ (t·ªëi ∆∞u kh·ªëi 6)
    pauseFullRecording();

    window.speechSynthesis.cancel();

    if (!englishVoice) {
      const v = selectEnglishVoice();
      if (!v) {
        pendingSpeakText = text;
        window.speechSynthesis.getVoices();
        return;
      }
    }

    const numberWords = {
      "0": "zero", "1": "one", "2": "two", "3": "three", "4": "four",
      "5": "five", "6": "six", "7": "seven", "8": "eight", "9": "nine", "10": "ten"
    };
    const processedText = text.replace(/Question\s+(\d+)/gi, (match, num) => {
      const w = numberWords[num];
      return w ? "Question " + w : match;
    });

    setTimeout(() => {
      const langCode = englishVoice && englishVoice.lang ? englishVoice.lang : "en-US";

      const intro = new SpeechSynthesisUtterance("Listen and answer.");
      intro.lang = langCode;
      intro.rate = 0.9;
      if (englishVoice) intro.voice = englishVoice;

      const main = new SpeechSynthesisUtterance(processedText);
      main.lang = langCode;
      main.rate = 0.9;
      if (englishVoice) main.voice = englishVoice;

      intro.onend = () => {
        setTimeout(() => window.speechSynthesis.speak(main), 700);
      };
      main.onend = () => {
        // resume audio recording sau khi ƒë·ªçc ƒë·ªÅ
        setTimeout(() => resumeFullRecording(), 100);
      };

      window.speechSynthesis.speak(intro);
    }, 50);
  }

  // ===================== Submit (no-cors + retry, t·ªëi ∆∞u kh·ªëi 6) =====================
  async function callScriptApiNoCors(action, payload) {
    if (!APPS_SCRIPT_URL) throw new Error("Missing APPS_SCRIPT_URL");

    const body = JSON.stringify({ action, ...payload });
    await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      redirect: "follow",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body
    });
    return true;
  }

  async function submitWithRetry(payload) {
    let ok = false;
    for (let i = 0; i < 2; i++) {
      try {
        ok = await callScriptApiNoCors("submitAll", payload);
        if (ok) return true;
      } catch(e) {}
      await sleep(600 * (i + 1));
    }
    return false;
  }

  // ===================== Render question =====================
  function renderQuestion() {
    const tId = $("topicSelect").value;
    const content = GRADE_9_QUESTIONS[tId] || "Content not found.";
    $("question").value = content;
    $("questionTextContainer").style.display = "none";

    $("answerText").value = "";
    $("sendBtn").disabled = true;
    stopTimer();

    if (recognition) { try { recognition.stop(); } catch(e) {} }
    isRecording = false;
    ignore_onend = true;

    if ("speechSynthesis" in window) window.speechSynthesis.cancel();

    $("startBtn").disabled = false;
    $("stopBtn").disabled = true;
    $("status").textContent = 'Nh·∫•n "B·∫Øt ƒë·∫ßu n√≥i" ƒë·ªÉ tr·∫£ l·ªùi.';

    canViewSuggestion = false;
    $("suggestBtn").disabled = true;
    $("suggestionsArea").textContent = "(B·∫°n s·∫Ω xem ƒë∆∞·ª£c g·ª£i √Ω sau khi g·ª≠i b√†i cho gi√°o vi√™n.)";

    // Reset recorder state for new topic
    try { pauseFullRecording(); } catch(e) {}
    // Kh√¥ng reset isFullRecordingStarted ƒë·ªÉ tr√°nh xin mic l·∫°i li√™n t·ª•c (m∆∞·ª£t h∆°n)
  }

  // ===================== UI init =====================
  document.addEventListener("DOMContentLoaded", () => {
    // Grade select
    GRADES.forEach((g) => {
      const opt = document.createElement("option");
      opt.value = g.id;
      opt.textContent = g.name;
      $("gradeSelect").appendChild(opt);
    });

    function updateTopics() {
      const g = GRADES.find((x) => x.id === $("gradeSelect").value);
      $("topicSelect").innerHTML = "";
      if (g) {
        g.topics.forEach((t) => {
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = t.name + (t.vn ? " - " + t.vn : "");
          $("topicSelect").appendChild(opt);
        });
      }
      renderQuestion();
    }

    $("gradeSelect").onchange = updateTopics;
    $("topicSelect").onchange = renderQuestion;
    updateTopics();

    $("showTextBtn").onclick = () => { $("questionTextContainer").style.display = "block"; };
    $("speakQuestionBtn").onclick = () => { speakText($("question").value); };

    // Init speech
    initSpeech();

    // Pending
    showPendingBox();

    // Start
    $("startBtn").onclick = async () => {
      // Ensure recorder + mic smooth
      try {
        await startFullRecordingIfNeeded();
        resumeFullRecording();
      } catch(e) {
        $("status").textContent = "Kh√¥ng th·ªÉ kh·ªüi t·∫°o ghi √¢m. H√£y c·∫•p quy·ªÅn Microphone.";
        return;
      }

      if (!recognition) initSpeech();
      if (!recognition) return;

      isRecording = true;
      ignore_onend = false;
      lastFinalNorm = "";

      try { recognition.start(); } catch(e) {}
      startTimer();

      $("status").textContent = "ƒêang ghi √¢m + ghi transcript... N√≥i to v√† r√µ.";
      $("startBtn").disabled = true;
      $("stopBtn").disabled = false;
    };

    // Stop
    $("stopBtn").onclick = () => {
      isRecording = false;
      ignore_onend = true;

      // stop recognition
      if (recognition) { try { recognition.stop(); } catch(e) {} }
      stopTimer();

      // pause audio recording (kh√¥ng stop ngay ƒë·ªÉ tr√°nh l·ªói mobile)
      pauseFullRecording();

      $("status").textContent = "ƒê√£ d·ª´ng. B·∫°n c√≥ th·ªÉ n·ªôp b√†i.";
      $("startBtn").disabled = false;
      $("stopBtn").disabled = true;

      // enable send if there is transcript (v·∫´n gi·ªØ logic c≈©)
      $("sendBtn").disabled = $("answerText").value.trim().length === 0;
    };

    // Clear
    $("clearBtn").onclick = () => {
      if (!confirm("X√≥a h·∫øt n·ªôi dung ƒë·ªÉ l√†m l·∫°i?")) return;

      isRecording = false;
      ignore_onend = true;
      if (recognition) { try { recognition.stop(); } catch(e) {} }
      stopTimer();

      $("answerText").value = "";
      $("sendBtn").disabled = true;
      $("status").textContent = "ƒê√£ x√≥a. Nh·∫•n B·∫Øt ƒë·∫ßu n√≥i ƒë·ªÉ l√†m l·∫°i.";
      $("startBtn").disabled = false;
      $("stopBtn").disabled = true;

      canViewSuggestion = false;
      $("suggestBtn").disabled = true;
      $("suggestionsArea").textContent = "(B·∫°n s·∫Ω xem ƒë∆∞·ª£c g·ª£i √Ω sau khi g·ª≠i b√†i cho gi√°o vi√™n.)";
    };

    // Suggest
    $("suggestBtn").onclick = () => {
      if (!canViewSuggestion) {
        alert("B·∫°n ch·ªâ ƒë∆∞·ª£c xem g·ª£i √Ω sau khi ƒë√£ ho√†n th√†nh v√† g·ª≠i b√†i cho gi√°o vi√™n.");
        return;
      }
      const tId = $("topicSelect").value;
      const suggestion = SUGGESTED_ANSWERS[tId] || "Hi·ªán ch∆∞a c√≥ g·ª£i √Ω cho ch·ªß ƒë·ªÅ n√†y.";
      $("suggestionsArea").textContent = suggestion;
    };

    // Send
    $("sendBtn").onclick = () => {
      const n = $("studentName").value.trim();
      const c = $("studentClass").value.trim();
      const q = $("question").value;
      const a = $("answerText").value.trim();
      const tOpt = document.querySelector("#topicSelect option:checked");
      const topicLabel = tOpt ? tOpt.text : "";

      if (!n || !c) { alert("‚ö†Ô∏è Thi·∫øu T√™n ho·∫∑c L·ªõp!"); return; }
      if (!a) { alert("‚ö†Ô∏è Ch∆∞a c√≥ transcript!"); return; }

      // stop recognition if running
      if (recognition) {
        isRecording = false;
        ignore_onend = true;
        try { recognition.stop(); } catch(e) {}
      }
      pauseFullRecording();
      stopTimer();

      $("sendBtn").disabled = true;
      $("resultArea").textContent = "ƒêang x·ª≠ l√Ω audio...";

      const payloadBase = {
        studentName: n,
        studentClass: c,
        topicLabel,
        question: q,
        transcript: a
      };

      const sendTranscriptOnly = async () => {
        $("resultArea").textContent = "ƒêang g·ª≠i transcript...";
        const ok = await submitWithRetry({ ...payloadBase, mimeType: "", dataUrl: "" });
        $("sendBtn").disabled = false;

        if (ok) {
          $("resultArea").innerHTML = '<span class="status-ok">ƒê√£ g·ª≠i (kh√¥ng c√≥ audio).</span>';
          canViewSuggestion = true;
          $("suggestBtn").disabled = false;
        } else {
          savePending({ ...payloadBase, mimeType: "", dataUrl: "" });
          $("resultArea").innerHTML = '<span class="status-error">G·ª≠i th·∫•t b·∫°i do l·ªói m·∫°ng. B√†i ƒë√£ ƒë∆∞·ª£c l∆∞u. H√£y b·∫•m "G·ª≠i l·∫°i b√†i v·ª´a l∆∞u".</span>';
        }
      };

      if (!isFullRecordingStarted) {
        sendTranscriptOnly();
        return;
      }

      stopFullRecording((blob) => {
        (async () => {
          try {
            if (!blob || !blob.size) {
              $("sendBtn").disabled = false;
              $("resultArea").innerHTML = '<span class="status-error">Kh√¥ng t·∫°o ƒë∆∞·ª£c file ghi √¢m. Vui l√≤ng th·ª≠ l·∫°i.</span>';
              return;
            }

            const mime = blob.type || audioMimeType || "audio/webm";
            const sizeMB = (blob.size / (1024 * 1024)).toFixed(2);

            // nh·ªè => dataUrl
            if (blob.size <= SMALL_BLOB_MAX) {
              $("resultArea").textContent = `Audio ${sizeMB}MB: ƒëang chuy·ªÉn ƒë·ªïi...`;
              const dataUrl = await new Promise((resolve) => blobToDataUrl(blob, resolve));

              if (!dataUrl) {
                $("sendBtn").disabled = false;
                $("resultArea").innerHTML = '<span class="status-error">L·ªói chuy·ªÉn ƒë·ªïi audio. Vui l√≤ng th·ª≠ l·∫°i.</span>';
                return;
              }

              let finalDataUrl = dataUrl;
              let finalMime = mime;

              if (finalDataUrl.length > MAX_DATAURL_CHARS) {
                finalDataUrl = "";
                finalMime = "";
              }

              const payload = {
                ...payloadBase,
                mimeType: finalMime,
                dataUrl: finalDataUrl
              };

              $("resultArea").textContent = finalDataUrl
                ? "ƒêang n·ªôp b√†i (audio + transcript)..."
                : "Audio qu√° l·ªõn (base64). ƒêang n·ªôp transcript...";

              const ok = await submitWithRetry(payload);
              $("sendBtn").disabled = false;

              if (ok) {
                $("resultArea").innerHTML = finalDataUrl
                  ? '<span class="status-ok">ƒê√£ n·ªôp th√†nh c√¥ng (k√®m audio)!</span>'
                  : '<span class="status-ok">ƒê√£ n·ªôp transcript (audio qu√° l·ªõn n√™n kh√¥ng g·ª≠i k√®m).</span>';
                canViewSuggestion = true;
                $("suggestBtn").disabled = false;
              } else {
                savePending(payload);
                $("resultArea").innerHTML = '<span class="status-error">N·ªôp b√†i th·∫•t b·∫°i do l·ªói m·∫°ng. B√†i ƒë√£ ƒë∆∞·ª£c l∆∞u. H√£y b·∫•m "G·ª≠i l·∫°i b√†i v·ª´a l∆∞u".</span>';
              }
              return;
            }

            // l·ªõn => chunk upload
            $("resultArea").textContent = `Audio ${sizeMB}MB: ƒëang chia nh·ªè & upload... (vui l√≤ng kh√¥ng tho√°t trang)`;

            try {
              await uploadAudioInChunksNoCors(blob, mime, payloadBase);
              $("sendBtn").disabled = false;
              $("resultArea").innerHTML = '<span class="status-ok">ƒê√£ n·ªôp th√†nh c√¥ng! Vui l√≤ng ki·ªÉm tra email GV (s·∫Ω c√≥ link audio).</span>';
              // V·ªõi no-cors, m·ªü g·ª£i √Ω sau khi upload xong
              canViewSuggestion = true;
              $("suggestBtn").disabled = false;
            } catch(e) {
              $("sendBtn").disabled = false;
              $("resultArea").innerHTML = '<span class="status-error">Upload audio b·ªã l·ªói (m·∫°ng y·∫øu/ƒë·ª©t). H√£y n·ªôp l·∫°i khi m·∫°ng ·ªïn ƒë·ªãnh v√† gi·ªØ trang m·ªü trong l√∫c g·ª≠i.</span>';
            }
          } catch(e) {
            $("sendBtn").disabled = false;
            $("resultArea").innerHTML = '<span class="status-error">C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.</span>';
          }
        })();
      });
    };
  });
</script>
</body>
</html>
